{% extends "base.html" %}

{% block title %}Dashboard - Allulose Tracker{% endblock %}
{% block header %}Dashboard{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block content %}
<!-- Active Timer Display -->
<div id="active-timer" class="hidden mb-2">
    <div class="timer-display">
        <div class="timer-variant" id="timer-variant"></div>
        <div class="timer-time" id="timer-elapsed">00:00:00</div>
        <div class="timer-since" id="timer-start"></div>
        <button class="btn btn-primary btn-block mt-1" onclick="stopTimer()">I'm Hungry - Log Entry</button>
    </div>
</div>

<!-- Quick Actions -->
<div class="quick-actions">
    <button class="quick-action-btn" onclick="showStartTimer()">
        <span class="quick-action-icon">‚è±Ô∏è</span>
        <span class="quick-action-label">Start Timer</span>
    </button>
    <button class="quick-action-btn" onclick="showGIForm()">
        <span class="quick-action-icon">üîî</span>
        <span class="quick-action-label">Log GI Event</span>
    </button>
</div>

<!-- Quick Check-in -->
<div class="card">
    <div class="card-header">Quick Check-in</div>
    <div class="metric-buttons">
        <button class="metric-btn" onclick="quickRate('energy')">
            <span class="metric-btn-icon">‚ö°</span>
            <span class="metric-btn-label">Energy</span>
        </button>
        <button class="metric-btn" onclick="quickRate('clarity')">
            <span class="metric-btn-icon">üß†</span>
            <span class="metric-btn-label">Clarity</span>
        </button>
        <button class="metric-btn" onclick="quickRate('mood')">
            <span class="metric-btn-icon">üòä</span>
            <span class="metric-btn-label">Mood</span>
        </button>
        <button class="metric-btn" onclick="quickRate('performance')">
            <span class="metric-btn-icon">üí™</span>
            <span class="metric-btn-label">Physical</span>
        </button>
    </div>
</div>

<!-- Today's Stats -->
<div class="card">
    <div class="card-header">Today's Ratings</div>
    <div class="card-grid">
        <div class="stat-card">
            <span class="stat-value" id="stat-energy">-</span>
            <span class="stat-label">Energy</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-clarity">-</span>
            <span class="stat-label">Clarity</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-mood">-</span>
            <span class="stat-label">Mood</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-performance">-</span>
            <span class="stat-label">Physical</span>
        </div>
    </div>
</div>

<!-- Experiment Insights -->
<div class="card">
    <div class="card-header">Experiment Insights</div>
    <div class="card-grid">
        <div class="stat-card">
            <span class="stat-value" id="stat-baseline">-</span>
            <span class="stat-label">Baseline Avg</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-allulose">-</span>
            <span class="stat-label">Allulose Avg</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-improvement">-</span>
            <span class="stat-label">Improvement</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="stat-entries">-</span>
            <span class="stat-label">Total Entries</span>
        </div>
    </div>
    <div id="gi-warning" class="hidden mt-1" style="padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 0.5rem; border: 1px solid var(--danger);">
        <div style="color: var(--danger); font-weight: 600;">‚ö†Ô∏è GI Threshold Warning</div>
        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Based on your logged events, consider limiting Allulose to <span id="gi-threshold" style="color: var(--danger); font-weight: 600;"></span>g per serving.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let timerInterval = null;

// Load active timer
async function loadTimer() {
    try {
        const timer = await apiRequest('/api/timer');
        if (timer) {
            displayTimer(timer);
            startTimerInterval(timer.start_time);
        }
    } catch (error) {
        console.error('Error loading timer:', error);
    }
}

// Display timer
function displayTimer(timer) {
    const activeTimer = document.getElementById('active-timer');
    const variantEl = document.getElementById('timer-variant');
    const startEl = document.getElementById('timer-start');

    activeTimer.classList.remove('hidden');

    const variantText = timer.variant === 'A' ? 'Variant A: Meal + Allulose' : 'Variant B: Allulose only';
    variantEl.textContent = variantText;
    startEl.textContent = `Started at ${formatTime(timer.start_time)}`;
}

// Start timer interval
function startTimerInterval(startTime) {
    if (timerInterval) {
        clearInterval(timerInterval);
    }

    updateTimerDisplay(startTime);
    timerInterval = setInterval(() => updateTimerDisplay(startTime), 1000);
}

// Update timer display
function updateTimerDisplay(startTime) {
    const elapsed = Math.floor((Date.now() - new Date(startTime)) / 1000);
    const hours = Math.floor(elapsed / 3600);
    const minutes = Math.floor((elapsed % 3600) / 60);
    const seconds = elapsed % 60;

    const display = [hours, minutes, seconds]
        .map(n => String(n).padStart(2, '0'))
        .join(':');

    document.getElementById('timer-elapsed').textContent = display;
}

// Show start timer modal
function showStartTimer() {
    const now = new Date();
    const formattedNow = formatDateTimeForInput(now.toISOString());

    const content = `
        <form id="start-timer-form" onsubmit="startTimer(event)">
            <div class="form-group">
                <label class="form-label">Select Variant</label>
                <select class="form-select" name="variant" required>
                    <option value="A">Variant A: Meal + Allulose</option>
                    <option value="B">Variant B: Allulose only</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Time</label>
                <input type="datetime-local" class="form-input" name="start_time" value="${formattedNow}" required>
            </div>
            <div id="variant-b-warning" class="hidden" style="padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 0.5rem; border: 1px solid var(--warning); margin-bottom: 1rem;">
                <div style="color: var(--warning); font-weight: 600;">‚ö†Ô∏è Safety Reminder</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    Make sure to eat a proper meal within a reasonable timeframe.
                </div>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Start Timer</button>
        </form>
    `;

    openModal('Start Hunger Timer', content);

    // Show warning for variant B
    document.querySelector('select[name="variant"]').addEventListener('change', (e) => {
        const warning = document.getElementById('variant-b-warning');
        if (e.target.value === 'B') {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }
    });
}

// Start timer
async function startTimer(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const data = {
        variant: formData.get('variant'),
        start_time: parseDateTimeInput(formData.get('start_time'))
    };

    try {
        await apiRequest('/api/timer', 'POST', data);
        showToast('Timer started!');
        closeModal();
        loadTimer();
    } catch (error) {
        console.error('Error starting timer:', error);
    }
}

// Stop timer and show hunger log form
async function stopTimer() {
    try {
        const timer = await apiRequest('/api/timer');
        if (!timer) return;

        const now = new Date();
        const duration = calculateMinutes(timer.start_time, now.toISOString());

        showHungerLogForm(timer, duration);
    } catch (error) {
        console.error('Error stopping timer:', error);
    }
}

// Show hunger log form
function showHungerLogForm(timer, duration) {
    const now = new Date();
    const formattedNow = formatDateTimeForInput(now.toISOString());
    const startTime = formatDateTimeForInput(timer.start_time);

    const content = `
        <form id="hunger-log-form" onsubmit="submitHungerLog(event)">
            <input type="hidden" name="variant" value="${timer.variant}">
            <input type="hidden" name="allulose_time" value="${timer.start_time}">

            <div class="form-group">
                <label class="form-label">Started (Allulose Time)</label>
                <input type="datetime-local" class="form-input" value="${startTime}" disabled>
            </div>

            <div class="form-group">
                <label class="form-label">Hunger Time</label>
                <input type="datetime-local" class="form-input" name="hunger_time" value="${formattedNow}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Duration (auto-calculated)</label>
                <input type="number" class="form-input" name="duration_minutes" value="${duration}" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">Activity Level</label>
                <select class="form-select" name="activity_level">
                    <option value="">Not specified</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Sleep Hours</label>
                    <input type="number" class="form-input" name="sleep_hours" step="0.5" min="0" max="24">
                </div>
                <div class="form-group">
                    <label class="form-label">Sleep Quality (1-10)</label>
                    <input type="number" class="form-input" name="sleep_quality" min="1" max="10">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Stress Level (1-10)</label>
                <input type="number" class="form-input" name="stress_level" min="1" max="10">
            </div>

            <div class="form-group">
                <label class="form-label">Concerta Timing</label>
                <input type="text" class="form-input" name="concerta_timing" placeholder="e.g., 8am, 2 hours before">
            </div>

            <div class="form-group">
                <label class="form-label">Water Intake (oz)</label>
                <input type="number" class="form-input" name="water_intake_oz" min="0">
            </div>

            <div class="form-group">
                <label class="form-label">Food Eaten</label>
                <textarea class="form-textarea" name="food_eaten" placeholder="What did you eat with the Allulose?"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" name="notes" placeholder="Any additional observations"></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-block">Log Entry</button>
        </form>
    `;

    openModal('Log Hunger Entry', content);

    // Auto-update duration when hunger_time changes
    document.querySelector('input[name="hunger_time"]').addEventListener('change', (e) => {
        const hungerTime = parseDateTimeInput(e.target.value);
        const newDuration = calculateMinutes(timer.start_time, hungerTime);
        document.querySelector('input[name="duration_minutes"]').value = newDuration;
    });
}

// Submit hunger log
async function submitHungerLog(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const data = {
        date: getCurrentDate(),
        variant: formData.get('variant'),
        allulose_time: formData.get('allulose_time'),
        hunger_time: parseDateTimeInput(formData.get('hunger_time')),
        duration_minutes: parseInt(formData.get('duration_minutes')),
        activity_level: formData.get('activity_level') || null,
        sleep_hours: formData.get('sleep_hours') ? parseFloat(formData.get('sleep_hours')) : null,
        sleep_quality: formData.get('sleep_quality') ? parseInt(formData.get('sleep_quality')) : null,
        stress_level: formData.get('stress_level') ? parseInt(formData.get('stress_level')) : null,
        concerta_timing: formData.get('concerta_timing') || null,
        water_intake_oz: formData.get('water_intake_oz') ? parseInt(formData.get('water_intake_oz')) : null,
        food_eaten: formData.get('food_eaten') || null,
        notes: formData.get('notes') || null,
        is_baseline: false
    };

    try {
        await apiRequest('/api/hunger', 'POST', data);
        await apiRequest('/api/timer', 'DELETE');

        if (timerInterval) {
            clearInterval(timerInterval);
        }

        document.getElementById('active-timer').classList.add('hidden');

        showToast('Hunger entry logged!');
        closeModal();
        loadStats();
    } catch (error) {
        console.error('Error logging hunger entry:', error);
    }
}

// Quick rate
function quickRate(metricType) {
    const metricNames = {
        energy: 'Energy',
        clarity: 'Clarity',
        mood: 'Mood',
        performance: 'Physical Performance'
    };

    const content = `
        <form id="quick-rate-form" onsubmit="submitQuickRate(event, '${metricType}')">
            <div class="form-group">
                <label class="form-label">Rate your ${metricNames[metricType]} (1-10)</label>
                <div class="slider-container">
                    <input type="range" class="slider" name="value" min="1" max="10" value="5" oninput="document.getElementById('slider-value').textContent = this.value">
                    <div class="slider-value" id="slider-value">5</div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="form-textarea" name="notes" placeholder="Any context or observations"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Submit Rating</button>
        </form>
    `;

    openModal(`Rate ${metricNames[metricType]}`, content);
}

// Submit quick rate
async function submitQuickRate(event, metricType) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const data = {
        date: getCurrentDate(),
        timestamp: getCurrentDateTime(),
        metric_type: metricType,
        value: parseInt(formData.get('value')),
        notes: formData.get('notes') || null
    };

    try {
        await apiRequest('/api/ratings', 'POST', data);
        showToast('Rating submitted!');
        closeModal();
        loadStats();
    } catch (error) {
        console.error('Error submitting rating:', error);
    }
}

// Show GI form
function showGIForm() {
    window.location.href = '/gi';
}

// Load stats
async function loadStats() {
    try {
        const stats = await apiRequest('/api/stats');

        // Update today's ratings
        document.getElementById('stat-energy').textContent = stats.today_ratings.energy.toFixed(1) || '-';
        document.getElementById('stat-clarity').textContent = stats.today_ratings.clarity.toFixed(1) || '-';
        document.getElementById('stat-mood').textContent = stats.today_ratings.mood.toFixed(1) || '-';
        document.getElementById('stat-performance').textContent = stats.today_ratings.performance.toFixed(1) || '-';

        // Update experiment insights
        document.getElementById('stat-baseline').textContent = stats.baseline_avg_minutes > 0 ? formatDuration(stats.baseline_avg_minutes) : '-';
        document.getElementById('stat-allulose').textContent = stats.allulose_avg_minutes > 0 ? formatDuration(stats.allulose_avg_minutes) : '-';

        const improvement = document.getElementById('stat-improvement');
        if (stats.improvement_minutes !== 0) {
            improvement.textContent = (stats.improvement_minutes > 0 ? '+' : '') + formatDuration(Math.abs(stats.improvement_minutes));
            improvement.className = 'stat-value ' + (stats.improvement_minutes > 0 ? 'text-success' : 'text-danger');
        } else {
            improvement.textContent = '-';
        }

        document.getElementById('stat-entries').textContent = stats.total_entries.hunger;

        // Show GI warning if threshold exists
        if (stats.gi_threshold) {
            document.getElementById('gi-warning').classList.remove('hidden');
            document.getElementById('gi-threshold').textContent = stats.gi_threshold;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    loadTimer();
    loadStats();
});
</script>
{% endblock %}
