{% extends "base.html" %}

{% block title %}Subjective Ratings - Allulose Tracker{% endblock %}
{% block header %}Subjective Ratings{% endblock %}
{% block nav_ratings %}active{% endblock %}

{% block content %}
<!-- Day Selector -->
<div class="day-selector">
    <button class="day-nav-btn" onclick="previousDay()" id="prev-btn">‚Üê Prev</button>
    <div class="current-day" id="current-day">Today</div>
    <button class="day-nav-btn" onclick="nextDay()" id="next-btn">Next ‚Üí</button>
</div>

<!-- Quick Rating Buttons -->
<div class="card">
    <div class="card-header">Quick Rate</div>
    <div class="metric-buttons">
        <button class="metric-btn" onclick="quickRate('energy')">
            <span class="metric-btn-icon">‚ö°</span>
            <span class="metric-btn-label">Energy</span>
        </button>
        <button class="metric-btn" onclick="quickRate('clarity')">
            <span class="metric-btn-icon">üß†</span>
            <span class="metric-btn-label">Clarity</span>
        </button>
        <button class="metric-btn" onclick="quickRate('mood')">
            <span class="metric-btn-icon">üòä</span>
            <span class="metric-btn-label">Mood</span>
        </button>
        <button class="metric-btn" onclick="quickRate('performance')">
            <span class="metric-btn-icon">üí™</span>
            <span class="metric-btn-label">Physical</span>
        </button>
    </div>
</div>

<!-- Individual Charts -->
<div class="card" id="energy-chart-card" style="display: none;">
    <div class="card-header">‚ö° Energy Throughout the Day</div>
    <div class="chart-container">
        <canvas id="energy-chart"></canvas>
    </div>
    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
        Each dot represents an energy rating logged at that time
    </div>
</div>

<div class="card" id="clarity-chart-card" style="display: none;">
    <div class="card-header">üß† Clarity Throughout the Day</div>
    <div class="chart-container">
        <canvas id="clarity-chart"></canvas>
    </div>
    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
        Each dot represents a clarity rating logged at that time
    </div>
</div>

<div class="card" id="mood-chart-card" style="display: none;">
    <div class="card-header">üòä Mood Throughout the Day</div>
    <div class="chart-container">
        <canvas id="mood-chart"></canvas>
    </div>
    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
        Each dot represents a mood rating logged at that time
    </div>
</div>

<div class="card" id="performance-chart-card" style="display: none;">
    <div class="card-header">üí™ Physical Throughout the Day</div>
    <div class="chart-container">
        <canvas id="performance-chart"></canvas>
    </div>
    <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.5rem;">
        Each dot represents a physical performance rating logged at that time
    </div>
</div>

<!-- Ratings List -->
<div class="card">
    <div class="card-header">Ratings for <span id="ratings-date">Today</span></div>
    <div id="ratings-list">
        <div class="loading">Loading ratings...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentDate = new Date();
let charts = {
    energy: null,
    clarity: null,
    mood: null,
    performance: null
};

// Metric info
const metricInfo = {
    energy: { name: 'Energy', icon: '‚ö°', color: '#f59e0b' },
    clarity: { name: 'Clarity', icon: 'üß†', color: '#3b82f6' },
    mood: { name: 'Mood', icon: 'üòä', color: '#ec4899' },
    performance: { name: 'Physical', icon: 'üí™', color: '#8b5cf6' }
};

// Load ratings for current date
async function loadRatings() {
    const dateStr = currentDate.toISOString().split('T')[0];

    try {
        const ratings = await apiRequest(`/api/ratings?date=${dateStr}`);

        const ratingsList = document.getElementById('ratings-list');

        if (ratings.length === 0) {
            ratingsList.innerHTML = '<div class="empty-state"><span class="empty-state-icon">‚≠ê</span><div class="empty-state-text">No ratings for this day</div></div>';
            updateChart([]);
            return;
        }

        // Sort by timestamp descending
        ratings.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        ratingsList.innerHTML = ratings.map(rating => {
            const info = metricInfo[rating.metric_type];
            return `
                <div class="entry-item">
                    <div class="entry-header">
                        <div class="entry-title">
                            ${info.icon} ${info.name}: ${rating.value}/10
                        </div>
                        <button class="entry-delete" onclick="deleteRating(${rating.id})" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div class="entry-meta">
                        ${formatTime(rating.timestamp)}
                    </div>
                    ${rating.notes ? `<div class="entry-details">${rating.notes}</div>` : ''}
                </div>
            `;
        }).join('');

        updateChart(ratings);
    } catch (error) {
        console.error('Error loading ratings:', error);
    }
}

// Update charts - create individual scatter plot for each metric
function updateChart(ratings) {
    console.log('updateChart called with', ratings.length, 'ratings');

    // Group ratings by metric type
    const ratingsByMetric = {
        energy: ratings.filter(r => r.metric_type === 'energy'),
        clarity: ratings.filter(r => r.metric_type === 'clarity'),
        mood: ratings.filter(r => r.metric_type === 'mood'),
        performance: ratings.filter(r => r.metric_type === 'performance')
    };

    // Create/update individual chart for each metric
    Object.keys(metricInfo).forEach(metricType => {
        createMetricChart(metricType, ratingsByMetric[metricType]);
    });
}

// Create individual chart for a specific metric
function createMetricChart(metricType, ratings) {
    const chartCard = document.getElementById(`${metricType}-chart-card`);
    const canvas = document.getElementById(`${metricType}-chart`);

    // Destroy existing chart
    if (charts[metricType]) {
        charts[metricType].destroy();
        charts[metricType] = null;
    }

    // Hide card if no data
    if (ratings.length === 0) {
        chartCard.style.display = 'none';
        return;
    }

    // Show card
    chartCard.style.display = 'block';

    // Sort by timestamp
    ratings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    // Prepare data points
    const dataPoints = ratings.map(r => ({
        x: new Date(r.timestamp),
        y: r.value
    }));

    console.log(`Creating ${metricType} chart with ${dataPoints.length} points`);

    const ctx = canvas.getContext('2d');
    const info = metricInfo[metricType];

    charts[metricType] = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: info.name,
                data: dataPoints,
                backgroundColor: info.color,
                borderColor: info.color,
                borderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 10,
                pointStyle: 'circle',
                tension: 0.3,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'nearest',
                    intersect: true,
                    backgroundColor: '#1e293b',
                    borderColor: info.color,
                    borderWidth: 1,
                    titleColor: info.color,
                    bodyColor: '#f1f5f9',
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            return `${info.name}: ${context.parsed.y}/10`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'hour',
                        displayFormats: {
                            hour: 'ha'
                        },
                        tooltipFormat: 'h:mm a'
                    },
                    grid: {
                        color: '#475569'
                    },
                    ticks: {
                        color: '#cbd5e1'
                    },
                    title: {
                        display: true,
                        text: 'Time of Day',
                        color: '#cbd5e1'
                    }
                },
                y: {
                    min: 0,
                    max: 10,
                    ticks: {
                        stepSize: 2,
                        color: '#cbd5e1'
                    },
                    grid: {
                        color: '#475569'
                    },
                    title: {
                        display: true,
                        text: 'Rating (1-10)',
                        color: '#cbd5e1'
                    }
                }
            }
        }
    });
}

// Update day display
function updateDayDisplay() {
    const dateStr = currentDate.toISOString().split('T')[0];
    const todayStr = new Date().toISOString().split('T')[0];

    document.getElementById('current-day').textContent = formatDate(dateStr);
    document.getElementById('ratings-date').textContent = formatDate(dateStr);

    // Disable next button if viewing today
    document.getElementById('next-btn').disabled = dateStr === todayStr;
}

// Previous day
function previousDay() {
    currentDate.setDate(currentDate.getDate() - 1);
    updateDayDisplay();
    loadRatings();
}

// Next day
function nextDay() {
    const tomorrow = new Date(currentDate);
    tomorrow.setDate(tomorrow.getDate() + 1);

    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    const todayStr = new Date().toISOString().split('T')[0];

    if (tomorrowStr <= todayStr) {
        currentDate = tomorrow;
        updateDayDisplay();
        loadRatings();
    }
}

// Quick rate
function quickRate(metricType) {
    const info = metricInfo[metricType];

    const content = `
        <form id="quick-rate-form" onsubmit="submitQuickRate(event, '${metricType}')">
            <div class="form-group">
                <label class="form-label">Rate your ${info.name} (1-10)</label>
                <div class="slider-container">
                    <input type="range" class="slider" name="value" min="1" max="10" value="5" oninput="document.getElementById('slider-value').textContent = this.value">
                    <div class="slider-value" id="slider-value">5</div>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Time (optional - defaults to now)</label>
                <input type="datetime-local" class="form-input" name="timestamp" value="${formatDateTimeForInput(new Date().toISOString())}">
            </div>
            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="form-textarea" name="notes" placeholder="Any context or observations"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Submit Rating</button>
        </form>
    `;

    openModal(`${info.icon} Rate ${info.name}`, content);
}

// Submit quick rate
async function submitQuickRate(event, metricType) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const timestamp = parseDateTimeInput(formData.get('timestamp'));

    const data = {
        date: new Date(timestamp).toISOString().split('T')[0],
        timestamp: timestamp,
        metric_type: metricType,
        value: parseInt(formData.get('value')),
        notes: formData.get('notes') || null
    };

    try {
        await apiRequest('/api/ratings', 'POST', data);
        showToast('Rating submitted!');
        closeModal();
        loadRatings();
    } catch (error) {
        console.error('Error submitting rating:', error);
    }
}

// Delete rating
async function deleteRating(id) {
    if (!confirmDelete('Delete this rating?')) return;

    try {
        await apiRequest(`/api/ratings/${id}`, 'DELETE');
        showToast('Rating deleted');
        loadRatings();
    } catch (error) {
        console.error('Error deleting rating:', error);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateDayDisplay();
    loadRatings();
});
</script>
{% endblock %}
